---
apiVersion: integreatly.org/v1alpha1
kind: GrafanaDataSource
metadata:
  name: prometheus-grafana-datasource
spec:
  name: prometheus.yaml
  datasources:
    - access: "proxy"
      basicAuth: true
      basicAuthUser: "internal"
      editable: false
      jsonData:
        tlsSkipVerify: true
      name: "prometheus"
      orgId: 1
      type: "prometheus"
      url: "https://prometheus-pelorus.{{ .Release.Namespace }}.svc:9091"
      version: 1
      {{ range $key, $value := (lookup "v1" "Secret" "openshift-monitoring" "grafana-datasources").data }}
      {{ if eq $key "prometheus.yaml" }}
      {{ range $k, $v := ($value | b64dec | fromJson).datasources }}
      basicAuthPassword: {{ $v.basicAuthPassword | quote }}
      {{ end }}
      {{ end }}
      {{ end }}
