name: Integration Tests
on:
  workflow_run:
    workflows: ["Pre Integration Tests"]
    types:
      - completed

jobs:
  integration-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download Artifact Docs
        uses: dawidd6/action-download-artifact@v2.24.3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: pre-integration-tests.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: builded-code-${{ matrix.python-version }}
          path: ./

      - name: Unzip builded code
        run:
          unzip builded-code-${{ matrix.python-version }}.zip
          rm -f builded-code-${{ matrix.python-version }}.zip

      - name: Run integration-test
        env:
          PAGER_DUTY_TOKEN: ${{ secrets.PAGER_DUTY_TOKEN }}
        run: make integration-tests